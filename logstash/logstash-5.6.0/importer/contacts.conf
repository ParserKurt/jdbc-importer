#file: import.conf
input {
	jdbc {
		# mysql jdbc connection string to our database, mydb
		jdbc_connection_string => "jdbc:mysql://hawkeye-test.clxybluj7kyg.ap-southeast-1.rds.amazonaws.com/hawkeye_staging_fixed?zeroDateTimeBehavior=convertToNull"
		# the user we wish to execute our statement as
		jdbc_user => "hetest"
		jdbc_password => "OGYyZTk5NjJkOGM"
		jdbc_driver_library => "/home/ubuntu/elastic/elastic-logstash/jdbc-importer/mysql-connector-java-5.1.45/mysql-connector-java-5.1.45-bin.jar"
		jdbc_driver_class => "com.mysql.jdbc.Driver"
		jdbc_fetch_size => "50000"
		use_column_value => true
		jdbc_paging_enabled => "true"
		tracking_column => "contact_id"
		tracking_column_type => "numeric"
		statement => "SELECT contact.keyword_id, account.id as 'account_id', contact.first_name, contact_group.id as 'contact_group_id', contact.last_name, contact.name, contact_group.name as 'contact_group_name',updater_user.email as 'updater_email', contact.mobile_number as 'mobile_number', contact.id as 'contact_id', contact_group.is_forward_group, account.name as 'account_name', creator_user.email as 'creator_user', `keyword`.`is_valid` as 'keyword_is_valid' FROM (`contact_group`) LEFT OUTER JOIN `user` creator_user ON `creator_user`.`id` = `contact_group`.`created_by_id` LEFT OUTER JOIN `user` updater_user ON `updater_user`.`id` = `contact_group`.`updated_by_id` LEFT OUTER JOIN `account` account ON `account`.`id` = `contact_group`.`account_id` LEFT OUTER JOIN `keyword` keyword ON `keyword`.`id` = `contact_group`.`keyword_id` LEFT OUTER JOIN `contactgroup_contact` cgc ON `cgc`.`contactgroup_id` =  `contact_group`.`id` LEFT OUTER JOIN `contact` contact on `cgc`.`contact_id` = `contact`.`id` where contact.is_valid = 1 group by contact.id and contact.date_created > NOW() - INTERVAL 180 DAY"
	}
}



filter {
  aggregate {
    task_id => "%{contact_id}"
    code => "
	map['groupName'] ||= []
        map['groupName'].push(event.get('group_names'))
	map['groupID'] ||= []
	map['groupID'].push(event.get('group_ids'))
	map['contact_id'] = event.get('contact_id')
	map['keyword_id'] = event.get('keyword_id')
	map['account_id'] = event.get('account_id')
	map['first_name'] = event.get('first_name')
	map['last_name'] = event.get('last_name')
	map['name'] = event.get('name')
	map['update_email'] = event.get('update_email')
	map['mobile_number'] = event.get('mobile_number')
	map['is_forward_group'] = event.get('is_forward_group')
	map['account_name'] = event.get('account_name')
	map['creator_user'] = event.get('creator_user')
	map['keyword_is_valid'] = event.get('keyword_is_valid')
     event.cancel()
    "
    push_previous_map_as_event => true
    timeout => 5
  }
  mutate {
    remove_field => ["contact_group_id", "contact_group_name"]
  }
}

output {
	elasticsearch {
		index => "hawkeye2"
		document_type => "contact"
		hosts => ["localhost:9200"]
		document_id => "%{contact_id}"
		
	}
} 
